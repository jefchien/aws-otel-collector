<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes" />
    <link rel="shortcut icon" type="image/png" href="/aws-otel-collector/assets/images/favicon-32x32.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous">
    <link rel="stylesheet" href="/aws-otel-collector/assets/css/style.css?v=" crossorigin="anonymous">
    <style>
      html {
        font-family: BlinkMacSystemFont,-apple-system,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Helvetica,Arial,sans-serif;
        -webkit-font-smoothing: antialiased;
        background-color: #fff;
        font-size: 16px;
      }
      body {
        color: #4a4a4a;
        font-size: 1em;
        font-weight: 400;
      }
      main {
        width: 100%;
        display: flex;
        flex-direction: column;
      }
      .spacer {
        flex: auto;
      }
      .small {
        font-size: 0.75rem;
      }
      .benchmark-set {
        margin: 8px 0;
        width: 100%;
        display: flex;
        flex-direction: column;
      }
      .benchmark-graphs {
        display: flex;
        flex-direction: row;
        justify-content: space-around;
        align-items: center;
        flex-wrap: wrap;
        width: 100%;
      }
      .benchmark-chart {
        max-width: 1000px;
      }
    </style>
    <title>Performance Trend | aws-otel-collector</title>
  </head>

  <body>
    <header class="page-header" role="banner">
      <div class="header-block">
        <div class="logo">
          <a href="/aws-otel-collector">
            <img src="/aws-otel-collector/assets/images/adot-logo.png">
          </a>
        </div>
        <div class="header-links">
          <ul>
            <li>
              <a href="/aws-otel-collector">
                <button class="header-button">
                  <span><i class="fa-solid fa-house"></i><span>Home</span></span>
                </button>
              </a>
            </li>
            <li>
              <a href="/aws-otel-collector/benchmark/report">
                <button class="header-button">
                  <span><i class="fa-solid fa-hourglass"></i><span>Performance Report</span></span>
                </button>
              </a>
            </li>
            <li>
              <a href="/aws-otel-collector/benchmark/trend">
                <button class="header-button">
                  <span><i class="fa-solid fa-arrow-trend-up"></i><span>Performance Trend</span></span>
                </button>
              </a>
            </li>
            <li>
              <a id="repository-link">
                <button class="header-button">
                  <span><i class="fa-solid fa-code"></i><span>Code on Github</span></span>
                </button>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </header>
    <div class="container-lg px-3 my-5 markdown-body">
      <h2>Performance Trend</h2>
      <p>
        <strong>Last Updated:</strong>
        <span id="last-update"></span>
      </p>
      <main id="main"></main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.2/Chart.min.js" integrity="sha512-uWTfEVcTAr+NF8RnQix39Vnfd93celVTAjU2pi4LpdrsPLeLg5RYywi5rw9oF8oCQaJ6b2YPALceNbf3kfDJaA==" crossorigin="anonymous"></script>
    <script src="data.js"></script>
    <script id="main-script">
      'use strict';
      (function() {
        const CHART_COLORS = {
          red: '#FF6384',
          orange: '#FF9F40',
          yellow: '#FFCD56',
          green: '#4BC0C0',
          blue: '#36A2EB',
          purple: '#9966FF',
          grey: '#C9CBCF'
        };

        const NAMED_COLORS = [
          CHART_COLORS.red,
          CHART_COLORS.orange,
          CHART_COLORS.yellow,
          CHART_COLORS.green,
          CHART_COLORS.blue,
          CHART_COLORS.purple,
          CHART_COLORS.grey
        ];

        function init() {
          function collectBenchesPerTestCase(entries) {
            const byGroup = new Map();
            const commits = [];
            for (const entry of entries) {
              const {commit, date, tool, benches} = entry;
              commits.push(commit);
              for (const bench of benches) {
                const result = { commit, date, tool, bench };
                let byName = byGroup.get(bench.extra);
                if (byName === undefined) {
                  byName = new Map();
                  byGroup.set(bench.extra, byName);
                }
                const results = byName.get(bench.name);
                if (results === undefined) {
                  byName.set(bench.name, [result]);
                } else {
                  results.push(result);
                }
              }
            }
            return {
              commits,
              byGroup
            };
          }

          const data = window.BENCHMARK_DATA;

          // Render header
          document.getElementById('last-update').textContent = new Date(data.lastUpdate).toString();
          const repoLink = document.getElementById('repository-link');
          repoLink.href = data.repoUrl;

          // Prepare data points for charts
          return Object.keys(data.entries).map(name => ({
            name,
            dataSet: collectBenchesPerTestCase(data.entries[name]),
          }));
        }

        function renderAllCharts(dataSets) {
          function renderGraph(parent, name, commits, byName) {
            const chartTitle = document.createElement('h3');
            chartTitle.textContent = name;
            parent.append(chartTitle);

            const canvas = document.createElement('canvas');
            canvas.className = 'benchmark-chart';
            parent.appendChild(canvas);

            const results = [];
            for (const [name, dataset] of byName.entries()) {
              results.push({ name, dataset });
            }
            results.sort((a, b) => a.name.localeCompare(b.name));

            const data = {
              labels: commits.map(commit => commit.id.slice(0, 7)),
              datasets: results.map(({ name, dataset }, index) => {
                const color = NAMED_COLORS[index % NAMED_COLORS.length];
                return {
                  label: name,
                  data: dataset.map(d => d.bench.value),
                  borderColor: color,
                  backgroundColor: color + '60', // Add alpha for #rrggbbaa
                };
              }),
            };
            const options = {
              scales: {
                xAxes: [
                  {
                    scaleLabel: {
                      display: true,
                      labelString: 'commit',
                    },
                  }
                ],
                yAxes: [
                  {
                    scaleLabel: {
                      display: true,
                      labelString: results?.[0]?.dataset[0].bench.unit ?? '',
                    },
                    ticks: {
                      beginAtZero: true,
                    }
                  }
                ],
              },
              tooltips: {
                callbacks: {
                  afterTitle: items => {
                    const { datasetIndex, index } = items[0];
                    const data = results[datasetIndex].dataset[index];
                    return '\n' + data.commit.message + '\n\n' + data.commit.timestamp + ' committed by @' + data.commit.author.username + '\n';
                  },
                  label: item => {
                    const { datasetIndex, index, value } = item;
                    const { name, dataset } = results[datasetIndex];
                    const { range, unit } = dataset[index].bench;
                    let label = `${name}: ${value}`;
                    label += unit;
                    if (range) {
                      label += ' (' + range + ')';
                    }
                    return label;
                  }
                }
              },
              onClick: (_mouseEvent, activeElems) => {
                if (activeElems.length === 0) {
                  return;
                }

                const { _datasetIndex: datasetIndex, _index: index } = activeElems[0];
                const url = results[datasetIndex].dataset[index].commit.url;
                window.open(url, '_blank');
              },
            };

            new Chart(canvas, {
              type: 'line',
              data,
              options,
            });
          }

          function renderBenchSet(benchSet, main) {
            const setElem = document.createElement('div');
            setElem.className = 'benchmark-set';
            main.appendChild(setElem);

            const graphsElem = document.createElement('div');
            graphsElem.className = 'benchmark-graphs';
            setElem.appendChild(graphsElem);

            const { commits, byGroup } = benchSet;
            const groups = [];
            for (const [name, byName] of byGroup.entries()) {
              groups.push({
                name,
                byName
              });
            }
            groups.sort((a, b) => a.name.localeCompare(b.name));

            for (const { name, byName } of groups) {
              renderGraph(graphsElem, name, commits, byName);
            }
          }

          const main = document.getElementById('main');
          for (const {dataSet} of dataSets) {
            renderBenchSet(dataSet, main);
          }
        }

        renderAllCharts(init()); // Start
      })();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
  </body>
</html>
